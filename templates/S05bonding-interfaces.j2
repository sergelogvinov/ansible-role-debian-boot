#!/bin/sh

modprobe bonding

{% for interface in ansible_interfaces|sort %}
{% set iface = ansible_facts[interface] %}
{% if iface.type is defined and iface.type == "bonding" and (iface['active'] | default(false)) %}

ip link add {{ interface }} type bond ||:
ip link set {{ interface }} down
ip link set {{ interface }} mtu {{ iface.mtu | default(1500) }}
echo "{{ iface.macaddress }}" > /sys/class/net/{{ interface }}/address
echo "{{ iface.mode | default('802.3ad') }}" > /sys/class/net/{{ interface }}/bonding/mode
echo "{{ iface.miimon | default(100) }}" > /sys/class/net/{{ interface }}/bonding/miimon
echo "{{ iface.lacp_rate | default('fast') }}" > /sys/class/net/{{ interface }}/bonding/lacp_rate
echo "1" > /sys/class/net/{{ interface }}/bonding/min_links

{% for slave in iface.slaves %}
ip link set {{ slave }} down
echo "+{{ slave }}" > /sys/class/net/{{ interface }}/bonding/slaves
{% endfor %}
{% if iface.ipv4.address is defined %}
ip addr add {{ iface.ipv4.address }}/{{ iface.ipv4.prefix }} dev {{ interface }}
{% endif %}
{% endif %}
{% endfor %}
