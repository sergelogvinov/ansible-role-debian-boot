#!/bin/sh

{% for interface in ansible_interfaces|sort %}
{% set iface = ansible_facts[interface] %}
{% if iface.type is defined and iface.type == "bonding" and (iface['active'] | default(false)) %}
{% for slave in iface.slaves %}
ip link set {{ slave }} down
{% endfor %}
ip link set {{ interface }} down
echo "{{ iface.mode | default('802.3ad') }}" > /sys/class/net/bond0/bonding/mode
echo "{{ iface.miimon | default(100) }}" > /sys/class/net/bond0/bonding/miimon
{% for slave in iface.slaves %}
echo "+{{ slave }}" > /sys/class/net/bond0/bonding/slaves
{% endfor %}
ip link set {{ interface }} up
ip addr add {{ ansible_default_ipv4.address }}/{{ ansible_default_ipv4.netmask }} dev {{ interface }}
ip route add default via {{ ansible_default_ipv4.gateway }} dev {{ interface }}
{% endif %}
{% endfor %}
